/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
var L=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var $=Object.prototype.hasOwnProperty;var V=(g,s)=>{for(var e in s)L(g,e,{get:s[e],enumerable:!0})},F=(g,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of N(s))!$.call(g,n)&&n!==e&&L(g,n,{get:()=>s[n],enumerable:!(t=R(s,n))||t.enumerable});return g};var j=g=>F(L({},"__esModule",{value:!0}),g);var O={};V(O,{default:()=>b});module.exports=j(O);var A=require("obsidian");var H=require("obsidian");var D=require("child_process"),v=class v{constructor(s){this.process=null;this.onDataCallback=null;this.onCompleteCallback=null;this.hasReceivedData=!1;this.startTime=0;this.sessionId=null;this.onSessionIdChange=null;this.currentProcessResolver=null;this.currentProcessRejecter=null;this.vaultPath=s}static getInstance(s){return v.instance||(v.instance=new v(s)),v.instance}setSessionIdChangeCallback(s){this.onSessionIdChange=s}setSessionId(s){this.sessionId=s,console.log("ClaudeProcess: Session ID set to:",s||"(none)")}getSessionId(){return this.sessionId}resetSession(){this.sessionId=null,this.onSessionIdChange&&this.onSessionIdChange(null)}isProcessing(){return this.process!==null}stopCommand(){this.process&&(console.log("ClaudeProcess: Stopping current process..."),this.cleanup(),this.currentProcessResolver&&this.currentProcessResolver())}async executeCommand(s,e,t,n=!1){return new Promise((i,a)=>{this.cleanup(),this.currentProcessResolver=i,this.currentProcessRejecter=a,this.onDataCallback=e,this.onCompleteCallback=t,this.startTime=Date.now(),console.log("ClaudeProcess: Starting command:",s),console.log("ClaudeProcess: Working directory:",this.vaultPath),console.log("ClaudeProcess: Session ID:",this.sessionId||"(new session)"),console.log("ClaudeProcess: Start time:",new Date().toISOString());let d=[];if(this.sessionId&&d.push("-r",this.sessionId),d.push("-p","--output-format","stream-json","--include-partial-messages","--verbose",s),console.log("ClaudeProcess: Spawning: claude",d.join(" ")),this.process=(0,D.spawn)("claude",d,{cwd:this.vaultPath,shell:!0,env:{...process.env,PATH:process.env.PATH},stdio:["pipe","pipe","pipe"],windowsHide:!0}),!this.process.stdout||!this.process.stderr||!this.process.stdin){a(new Error("Failed to create process stdio"));return}this.process.stdout.setEncoding("utf-8"),this.process.stderr.setEncoding("utf-8"),this.process.stdin.end(),this.hasReceivedData=!1;let l=!1,r=!1,p="";this.process.stdout.on("data",c=>{var I,B,P;let o=c.toString();this.hasReceivedData=!0;let f=Date.now()-this.startTime;console.log(`ClaudeProcess: Raw chunk (${o.length} chars):`,o.substring(0,200)),p+=o;let S=p.split(`
`);p=S.pop()||"";for(let E of S)if(E.trim()){console.log("ClaudeProcess: Processing line:",E.substring(0,200));try{let h=JSON.parse(E);if(console.log("ClaudeProcess: Parsed JSON type:",h.type),h.type==="system"&&h.session_id)this.sessionId=h.session_id,console.log(`ClaudeProcess: Captured session ID: ${this.sessionId}`),this.onSessionIdChange&&this.onSessionIdChange(this.sessionId);else if(h.type==="stream_event"&&((I=h.event)==null?void 0:I.type)==="content_block_delta"){let u=h.event.delta;(u==null?void 0:u.type)==="text_delta"&&(u!=null&&u.text)?(l=!0,console.log(`ClaudeProcess: Streamed text (${u.text.length} chars, ${f}ms):`,u.text.substring(0,50)),this.onDataCallback&&this.onDataCallback(u.text)):console.log("ClaudeProcess: Skipping delta type:",u==null?void 0:u.type)}else if(h.type==="assistant"&&((B=h.message)!=null&&B.content)&&!r)if(r=!0,l)console.log("ClaudeProcess: Skipping assistant message (text_delta already received)");else for(let u of h.message.content)u.type==="text"&&u.text&&(console.log(`ClaudeProcess: Assistant message text (${u.text.length} chars)`),this.onDataCallback&&this.onDataCallback(u.text));else h.type==="result"&&h.result&&!r?(console.log(`ClaudeProcess: Result output (${h.result.length} chars)`),this.onDataCallback&&this.onDataCallback(h.result)):h.type==="stream_event"&&((P=h.event)==null?void 0:P.type)==="message_stop"?console.log("ClaudeProcess: Message complete"):h.type==="error"?console.error("ClaudeProcess: Stream error:",h.error):console.log("ClaudeProcess: Unhandled JSON type:",h.type,h)}catch(h){console.log("ClaudeProcess: Not JSON, outputting raw:",E.substring(0,100)),this.onDataCallback&&this.onDataCallback(E)}}}),this.process.stderr.on("data",c=>{let o=c.toString();this.hasReceivedData=!0;let f=Date.now()-this.startTime;if(console.log(`ClaudeProcess: stderr (${o.length} chars, ${f}ms):`,o.substring(0,100)),o.includes("already in use")&&o.includes("Session ID")&&!n){console.warn("ClaudeProcess: Session conflict detected, retrying with new session"),this.onDataCallback&&this.onDataCallback(`

\u26A0\uFE0F \u68C0\u6D4B\u5230\u4F1A\u8BDD\u51B2\u7A81\uFF0C\u6B63\u5728\u521B\u5EFA\u65B0\u4F1A\u8BDD...

`),this.sessionId=null,this.onSessionIdChange&&this.onSessionIdChange(null),this.cleanup(),setTimeout(()=>{this.executeCommand(s,e,t,!0).then(()=>{this.currentProcessResolver&&this.currentProcessResolver()}).catch(S=>{this.currentProcessRejecter&&this.currentProcessRejecter(S)})},100);return}this.onDataCallback&&this.onDataCallback(o)}),this.process.on("close",c=>{let o=Date.now()-this.startTime;console.log(`ClaudeProcess: Process closed with code: ${c}, hadData: ${this.hasReceivedData}, ${o}ms total`),this.onCompleteCallback&&this.onCompleteCallback(),c===0?this.currentProcessResolver&&this.currentProcessResolver():this.hasReceivedData?(console.log("ClaudeProcess: Non-zero exit but data received, resolving"),this.currentProcessResolver&&this.currentProcessResolver()):this.currentProcessRejecter&&this.currentProcessRejecter(new Error(`Process exited with code ${c}`)),this.process=null}),this.process.on("exit",(c,o)=>{let f=Date.now()-this.startTime;console.log(`ClaudeProcess: Process exit - code: ${c}, signal: ${o}, hadData: ${this.hasReceivedData}, ${f}ms total`)}),this.process.on("error",c=>{let o=Date.now()-this.startTime;console.error(`ClaudeProcess: Process error after ${o}ms:`,c),c.message.includes("ENOENT")?this.currentProcessRejecter&&this.currentProcessRejecter(new Error("Claude command not found. Please install Claude Code CLI.")):this.currentProcessRejecter&&this.currentProcessRejecter(c),this.process=null}),console.log("ClaudeProcess: Process spawned, PID:",this.process.pid)})}cleanup(){if(this.process){let s=Date.now()-this.startTime;console.log(`ClaudeProcess: Cleaning up process after ${s}ms`),this.process.kill(),this.process=null}this.onDataCallback=null,this.onCompleteCallback=null,this.currentProcessResolver=null,this.currentProcessRejecter=null}};v.instance=null;var w=v;var M=class{constructor(s,e,t){this.stopButtonEl=null;this.commandHistory=[];this.historyIndex=-1;this.tempInput="";this.containerEl=s,this.onSubmit=e,this.onStop=t,this.render()}render(){let s=this.containerEl.createEl("div",{cls:"claude-chat-input-container"});this.inputWrapperEl=s.createEl("div",{cls:"claude-chat-input-wrapper"}),this.inputEl=this.inputWrapperEl.createEl("textarea",{cls:"claude-chat-input",attr:{placeholder:"Enter a command for Claude...",rows:"1"}}),this.inputEl.addEventListener("input",()=>{this.autoResize()}),this.sendButtonEl=this.inputWrapperEl.createEl("button",{cls:"claude-chat-send-button"}),this.sendButtonEl.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            <span>Send</span>
        `,this.sendButtonEl.addEventListener("click",()=>{this.handleSubmit()}),this.inputEl.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey?(e.preventDefault(),this.handleSubmit()):e.key==="ArrowUp"?(e.preventDefault(),this.navigateHistory(-1)):e.key==="ArrowDown"&&(e.preventDefault(),this.navigateHistory(1))}),s.addEventListener("click",e=>{(e.target===s||e.target===this.inputWrapperEl)&&this.inputEl.focus()})}createStopButton(){this.stopButtonEl||(this.stopButtonEl=this.inputWrapperEl.createEl("button",{cls:"claude-chat-stop-button"}),this.stopButtonEl.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            </svg>
            <span>Stop</span>
        `,this.stopButtonEl.addEventListener("click",()=>{this.onStop()}))}removeStopButton(){this.stopButtonEl&&(this.stopButtonEl.remove(),this.stopButtonEl=null)}async handleSubmit(){let s=this.inputEl.value.trim();s&&!this.sendButtonEl.disabled&&(this.commandHistory[this.commandHistory.length-1]!==s&&(this.commandHistory.push(s),this.commandHistory.length>100&&this.commandHistory.shift()),this.inputEl.value="",this.autoResize(),this.historyIndex=-1,this.tempInput="",await this.onSubmit(s))}navigateHistory(s){if(this.commandHistory.length===0)return;if(this.historyIndex===-1&&(this.tempInput=this.inputEl.value),this.historyIndex+=s,this.historyIndex<0)this.historyIndex=0;else if(this.historyIndex>=this.commandHistory.length){this.historyIndex=-1,this.setValue(this.tempInput);return}let e=this.commandHistory[this.commandHistory.length-1-this.historyIndex];this.setValue(e),this.inputEl.setSelectionRange(0,e.length)}autoResize(){this.inputEl.style.height="auto";let s=Math.min(Math.max(this.inputEl.scrollHeight,44),140);this.inputEl.style.height=`${s}px`}focus(){this.inputEl.focus()}setDisabled(s){this.inputEl.disabled=s,this.sendButtonEl.disabled=s}setProcessing(s){s?(this.sendButtonEl.classList.add("claude-hidden"),this.createStopButton(),this.inputEl.disabled=!0):(this.sendButtonEl.classList.remove("claude-hidden"),this.removeStopButton(),this.inputEl.disabled=!1)}getValue(){return this.inputEl.value}setValue(s){this.inputEl.value=s,this.autoResize()}};var C=require("obsidian"),y=class{constructor(s,e){this.app=e;this.currentMessageTextEl=null;this.currentMessageBuffer="";this.currentCursorEl=null;this.currentMessageEl=null;this.scrollLocked=!1;this.scrollBottomButton=null;this.messages=[];this.messageElements=new Map;this.containerEl=s,this.messagesEl=this.containerEl.createEl("div",{cls:"claude-chat-messages"}),this.setupLinkClickHandler(),this.setupScrollLock(),this.setupEditHandler()}setOnEditMessage(s){this.onEditMessage=s}setupScrollLock(){this.messagesEl.addEventListener("scroll",()=>{let s=this.messagesEl.scrollHeight-this.messagesEl.scrollTop<=this.messagesEl.clientHeight+50;!s&&!this.scrollLocked?(this.scrollLocked=!0,this.showScrollBottomButton()):s&&this.scrollLocked&&(this.scrollLocked=!1,this.hideScrollBottomButton())})}showScrollBottomButton(){this.scrollBottomButton||(this.scrollBottomButton=this.containerEl.createEl("button",{cls:"claude-scroll-bottom-button"}),this.scrollBottomButton.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>New messages</span>
        `,this.scrollBottomButton.addEventListener("click",()=>{this.scrollToBottomNow()}))}hideScrollBottomButton(){this.scrollBottomButton&&(this.scrollBottomButton.remove(),this.scrollBottomButton=null)}setupLinkClickHandler(){this.messagesEl.addEventListener("click",s=>{let e=s.target;if(e.tagName==="A"){s.preventDefault(),this.handleLinkClick(e);return}if(e.classList.contains("internal-link")){s.preventDefault(),this.handleInternalLinkClick(e);return}})}handleLinkClick(s){let e=s.getAttribute("href");if(e){if(e.startsWith("#")){console.log("Anchor link:",e);return}if(e.includes(".md")||e.includes(".png")||e.includes(".jpg")){this.tryOpenFile(e);return}window.open(e,"_blank")}}handleInternalLinkClick(s){let e=s.textContent;e&&this.tryOpenFile(e)}tryOpenFile(s){let e=s.replace(/^\[\[/,"").replace(/\]\]$/,"").replace(/\|.*$/,"").replace(/#.*/,"").trim(),t=this.app.metadataCache,n=this.app.vault,i=t.getFirstLinkpathDest(e,"");!i&&!e.endsWith(".md")&&(i=t.getFirstLinkpathDest(e+".md","")),i||(i=n.getMarkdownFiles().find(d=>{let l=d.basename.toLowerCase(),r=e.toLowerCase();return l===r||l.includes(r)})),i instanceof C.TFile?this.openFileInMainPane(i):console.log("File not found:",e)}openFileInMainPane(s){let e=this.app.workspace,t=e.getActiveViewOfType("markdown");if(!t){let n=e.getLeavesOfType("markdown");n.length>0&&(t=n[0])}if(t){let n=e.getLeafById(t.id);n&&n.openFile(s)}else e.getLeaf(!1).openFile(s)}addMessage(s){s.role!=="system"&&this.messages.push(s);let e=this.messagesEl.createEl("div",{cls:`claude-chat-message claude-chat-message-${s.role}`});if(s.role!=="system"){this.messageElements.set(e,s);let a=this.messages.length-1;e.dataset.messageIndex=a.toString()}let n=e.createEl("div",{cls:"claude-chat-message-content"}).createEl("div",{cls:"claude-chat-message-text"});n.innerHTML=this.formatContent(s.content);let i=e.createEl("div",{cls:"claude-chat-message-timestamp"});return i.textContent=this.formatTime(s.timestamp),this.addMessageCopyButton(e,s.content),s.role==="user"&&this.addEditButton(e),this.scrollToBottom(),n}addMessageCopyButton(s,e){let t=s.createEl("button",{cls:"claude-message-copy-button"});t.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        `,t.addEventListener("click",async n=>{n.stopPropagation(),await navigator.clipboard.writeText(e),t.classList.add("copied"),t.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            `,setTimeout(()=>{t.classList.remove("copied"),t.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                `},2e3)})}setupEditHandler(){this.messagesEl.addEventListener("click",s=>{let t=s.target.closest(".claude-message-edit-button");if(t){s.preventDefault(),s.stopPropagation();let n=t.closest(".claude-chat-message");n&&this.enterEditMode(n)}})}addEditButton(s){let e=s.createEl("button",{cls:"claude-message-edit-button"});e.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        `}enterEditMode(s){let e=s.querySelector(".claude-chat-message-text");if(!e)return;let t=parseInt(s.dataset.messageIndex||"-1");if(t<0)return;let n=this.messages[t];if(!n)return;let i=e.createEl("textarea",{cls:"claude-message-edit-textarea"});i.value=n.content;let a=e.createEl("div",{cls:"claude-message-edit-buttons"}),d=a.createEl("button",{cls:"claude-message-edit-save",text:"Save & Resend"}),l=a.createEl("button",{cls:"claude-message-edit-cancel",text:"Cancel"});e.querySelectorAll(":scope > :not(textarea):not(.claude-message-edit-buttons)").forEach(o=>o.style.display="none"),i.focus(),i.setSelectionRange(i.value.length,i.value.length);let p=()=>{let o=i.value.trim();o&&o!==n.content?(n.content=o,e.innerHTML=this.formatContent(o),this.onEditMessage&&this.onEditMessage(t,o)):this.exitEditMode(s,e)},c=()=>{this.exitEditMode(s,e)};d.addEventListener("click",p),l.addEventListener("click",c),i.addEventListener("keydown",o=>{o.key==="Enter"&&!o.shiftKey?(o.preventDefault(),p()):o.key==="Escape"&&(o.preventDefault(),c())})}exitEditMode(s,e){let t=e.querySelector(".claude-message-edit-textarea"),n=e.querySelector(".claude-message-edit-buttons");t&&t.remove(),n&&n.remove(),e.querySelectorAll(":scope > *").forEach(a=>a.style.display="")}addUserMessage(s){return this.addMessage({role:"user",content:s,timestamp:new Date})}createAssistantMessage(){let s=this.messagesEl.createEl("div",{cls:"claude-chat-message claude-chat-message-assistant"});this.currentMessageEl=s;let t=s.createEl("div",{cls:"claude-chat-message-content"}).createEl("div",{cls:"claude-chat-message-text"});this.addThinkingIndicator(t);let n=s.createEl("div",{cls:"claude-chat-message-timestamp"});return n.textContent=this.formatTime(new Date),this.currentMessageTextEl=t,this.currentMessageBuffer="",this.scrollToBottom(),t}appendToAssistantMessage(s){this.currentMessageTextEl&&(this.removeThinkingIndicator(),this.currentMessageBuffer+=s,this.currentMessageTextEl.textContent=this.currentMessageBuffer,this.addTypingCursor(),this.scrollToBottom())}finalizeAssistantMessage(){this.currentMessageTextEl&&(this.removeTypingCursor(),this.currentMessageBuffer&&(this.currentMessageBuffer.endsWith(`
`)||(this.currentMessageBuffer+=`
`),this.currentMessageTextEl.empty(),C.MarkdownRenderer.renderMarkdown(this.currentMessageBuffer,this.currentMessageTextEl,"",new C.Component),this.addCopyButtonsToCodeBlocks(this.currentMessageTextEl),this.messages.push({role:"assistant",content:this.currentMessageBuffer,timestamp:new Date}))),this.currentMessageEl&&this.addMessageCopyButton(this.currentMessageEl,this.currentMessageBuffer),this.currentMessageTextEl=null,this.currentMessageBuffer="",this.currentMessageEl=null}addCopyButtonsToCodeBlocks(s){s.querySelectorAll("pre").forEach(t=>{if(t.querySelector(".claude-code-copy-button"))return;let n=t.createEl("button",{cls:"claude-code-copy-button"});n.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <span>Copy</span>
            `,n.addEventListener("click",async()=>{let i=t.querySelector("code");if(i){let a=i.textContent||"";await navigator.clipboard.writeText(a),n.classList.add("copied"),n.innerHTML=`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        <span>Copied!</span>
                    `,setTimeout(()=>{n.classList.remove("copied"),n.innerHTML=`
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <span>Copy</span>
                        `},2e3)}})})}showThinking(){this.currentMessageTextEl&&!this.currentMessageBuffer&&this.addThinkingIndicator(this.currentMessageTextEl)}hideThinking(){this.removeThinkingIndicator()}addThinkingIndicator(s){if(s.querySelector(".claude-chat-message-thinking"))return;let t=s.createEl("div",{cls:"claude-chat-message-thinking"}),n=t.createEl("div",{cls:"claude-thinking-dots"});for(let a=0;a<3;a++)n.createEl("span",{cls:"claude-thinking-dot"});let i=t.createEl("span",{cls:"claude-thinking-text",text:"Thinking"})}removeThinkingIndicator(){if(this.currentMessageTextEl){let s=this.currentMessageTextEl.querySelector(".claude-chat-message-thinking");s&&s.remove()}}addTypingCursor(){this.currentMessageTextEl&&(this.removeTypingCursor(),this.currentCursorEl=this.currentMessageTextEl.createEl("span",{cls:"claude-typing-cursor"}))}removeTypingCursor(){this.currentCursorEl&&(this.currentCursorEl.remove(),this.currentCursorEl=null)}formatContent(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>")}formatTime(s){return s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}scrollToBottom(){this.scrollLocked||(this.messagesEl.scrollTop=this.messagesEl.scrollHeight)}scrollToBottomNow(){this.messagesEl.scrollTop=this.messagesEl.scrollHeight,this.scrollLocked=!1,this.hideScrollBottomButton()}clear(){this.messagesEl.empty(),this.messages=[],this.currentMessageTextEl=null,this.currentMessageBuffer="",this.scrollLocked=!1,this.hideScrollBottomButton()}getMessages(){return[...this.messages]}removeMessagesAfter(s){this.messages=this.messages.slice(0,s+1),this.messagesEl.querySelectorAll(".claude-chat-message").forEach((n,i)=>{i>s&&n.remove()}),this.messageElements.clear(),this.messagesEl.querySelectorAll(".claude-chat-message").forEach((n,i)=>{i<this.messages.length&&(this.messageElements.set(n,this.messages[i]),n.dataset.messageIndex=i.toString())})}};var k=class{constructor(s,e){this.sessions=[];this.currentSessionId=null;this.containerEl=s,this.onSessionSelect=e.onSessionSelect,this.onNewSession=e.onNewSession,this.onSessionDelete=e.onSessionDelete,this.onSessionRename=e.onSessionRename,console.log("SessionTabs: Constructor called, container:",s),this.render()}updateSessions(s,e){this.sessions=s,this.currentSessionId=e,console.log("SessionTabs: updateSessions called with",s.length,"sessions"),this.render()}render(){this.containerEl.empty(),this.containerEl.addClass("claude-session-tabs"),console.log("SessionTabs: render() called, sessions:",this.sessions.length);let s=this.containerEl.createEl("div",{cls:"claude-session-tabs-container"}),t=s.createEl("div",{cls:"claude-session-tabs-scroll"}).createEl("div",{cls:"claude-session-tabs-list"});if(this.sessions.length===0){let i=t.createEl("div",{cls:"claude-session-tabs-empty"});i.textContent="No sessions"}else for(let i of this.sessions){let a=this.createTab(i);t.appendChild(a)}let n=s.createEl("button",{cls:"claude-session-tab-new"});n.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14M5 12h14"></path>
            </svg>
        `,n.setAttribute("aria-label","New session"),n.addEventListener("click",()=>{this.onNewSession&&this.onNewSession()}),console.log("SessionTabs: render() complete")}createTab(s){let e=s.id===this.currentSessionId,t=document.createElement("div");t.className="claude-session-tab",e&&t.classList.add("claude-session-tab-active");let n=t.createEl("div",{cls:"claude-session-tab-content"}),i=n.createEl("span",{cls:"claude-session-tab-name"});if(i.textContent=s.name,this.sessions.length>1){let a=n.createEl("button",{cls:"claude-session-tab-close"});a.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6L6 18M6 6l12 12"></path>
                </svg>
            `,a.setAttribute("aria-label","Close session"),a.addEventListener("click",d=>{d.stopPropagation(),this.confirmClose(s.id)})}return n.addEventListener("click",()=>{this.onSessionSelect&&!e&&this.onSessionSelect(s.id)}),n.addEventListener("dblclick",()=>{this.promptRename(s.id)}),t}promptRename(s){let e=this.sessions.find(n=>n.id===s);if(!e)return;let t=prompt("Enter session name:",e.name);t&&t.trim()&&t!==e.name&&this.onSessionRename&&this.onSessionRename(s,t.trim())}confirmClose(s){let e=this.sessions.find(t=>t.id===s);e&&this.sessions.length!==1&&confirm(`Close session "${e.name}"?`)&&this.onSessionDelete&&this.onSessionDelete(s)}};var m="claude-chat-view";var x=class extends H.ItemView{constructor(e,t){super(e);this.isProcessing=!1;this.plugin=t;let n=this.app.vault.adapter.basePath||"";this.processManager=w.getInstance(n),this.sessionManager=t.sessionManager}getViewType(){return m}getDisplayText(){return"Claude Chat"}getIcon(){return"message-square"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("claude-chat-container");let t=this.app.vault.adapter.basePath||"";console.log("ClaudeChatView: Vault path:",t);let i=e.createEl("div",{cls:"claude-chat-main-layout"}).createEl("div",{cls:"claude-chat-content"}),a=i.createEl("div",{cls:"claude-session-tabs-wrapper"});this.sessionTabs=new k(a,{onSessionSelect:r=>this.loadSession(r),onNewSession:()=>this.createNewSession(),onSessionDelete:r=>this.deleteSession(r),onSessionRename:(r,p)=>this.renameSession(r,p)}),this.updateSessionList();let d=this.sessionManager.getCurrentCliSessionId();d&&(console.log("ClaudeChatView: Restoring session ID:",d),this.processManager.setSessionId(d)),this.processManager.setSessionIdChangeCallback(async r=>{console.log("ClaudeChatView: Session ID changed, saving:",r||"(null)"),await this.plugin.updateSessionId(r)}),this.messageContainer=new y(i,this.app),this.messageContainer.setOnEditMessage(async(r,p)=>{await this.handleEditMessage(r,p)}),this.loadCurrentSessionMessages();let l=i.createEl("div",{cls:"claude-chat-input-actions"});this.createActionButton(l,"Export","Export conversation to Markdown (Ctrl+Shift+E)",()=>this.exportConversation()),this.createActionButton(l,"Clear","Clear chat history (Ctrl+K)",()=>this.clearHistory()),this.createActionButton(l,"Regenerate","Regenerate last response",()=>this.regenerateLast()),this.chatInput=new M(i,async r=>{await this.handleCommand(r)},()=>{this.handleStop()})}createActionButton(e,t,n,i){let a=e.createEl("button",{cls:"claude-chat-action-button"});a.textContent=t,a.setAttribute("aria-label",n),a.setAttribute("title",n),a.addEventListener("click",i)}loadCurrentSessionMessages(){let e=this.sessionManager.getCurrentMessages();if(e.length===0)this.messageContainer.addMessage({role:"system",content:"Claude Chat - Enter commands to interact with Claude Code CLI\n\n**Keyboard Shortcuts:**\n\u2022 `Ctrl+Shift+N` - New session\n\u2022 `Ctrl+Shift+E` - Export conversation\n\u2022 `Ctrl+K` - Clear history\n\u2022 `Ctrl+L` - Focus input\n\u2022 `\u2191/\u2193` - Browse command history\n\u2022 `Shift+Enter` - New line\n\u2022 `Escape` - Stop generation\n\n**Tips:**\n\u2022 Click on user messages to edit and resend\n\u2022 Hover over messages to copy content\n\u2022 Use the toolbar buttons for quick actions",timestamp:new Date});else for(let t of e)this.messageContainer.addMessage(t)}updateSessionList(){var e;this.sessionTabs.updateSessions(this.sessionManager.getSessions(),((e=this.sessionManager.getCurrentSession())==null?void 0:e.id)||null)}async handleCommand(e){if(console.log("ClaudeChatView: handleCommand called with:",e),this.isProcessing){console.log("ClaudeChatView: Already processing, ignoring");return}this.isProcessing=!0,this.chatInput.setProcessing(!0),this.messageContainer.addUserMessage(e),this.sessionManager.addMessage({role:"user",content:e,timestamp:new Date}),this.messageContainer.createAssistantMessage();try{console.log("ClaudeChatView: Executing command..."),await this.processManager.executeCommand(e,t=>{console.log("ClaudeChatView: Received chunk:",t.substring(0,50)),this.messageContainer.appendToAssistantMessage(t)},()=>{console.log("ClaudeChatView: Command completed"),this.messageContainer.finalizeAssistantMessage();let t=this.messageContainer.getMessages(),n=t[t.length-1];n&&n.role==="assistant"&&this.sessionManager.addMessage(n),this.updateSessionList()}),console.log("ClaudeChatView: Command execution finished successfully")}catch(t){console.error("ClaudeChatView: Command error:",t),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

**Error:** ${t.message}`),this.messageContainer.finalizeAssistantMessage();let n=this.messageContainer.getMessages(),i=n[n.length-1];i&&i.role==="assistant"&&this.sessionManager.addMessage(i)}finally{this.isProcessing=!1,this.chatInput.setProcessing(!1),this.chatInput.focus()}}handleStop(){console.log("ClaudeChatView: Stop requested"),this.isProcessing&&(this.processManager.stopCommand(),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

_Stopped by user_`),this.messageContainer.finalizeAssistantMessage(),this.isProcessing=!1,this.chatInput.setProcessing(!1))}clearHistory(){this.sessionManager.clearCurrentSession(),this.messageContainer.clear(),this.messageContainer.addMessage({role:"system",content:"Claude Chat - History cleared",timestamp:new Date}),this.updateSessionList()}focusInput(){this.chatInput.focus()}loadSession(e){if(!this.sessionManager.switchSession(e)){console.error("ClaudeChatView: Failed to switch to session:",e);return}let n=this.sessionManager.getCurrentSession();n&&this.processManager.setSessionId(n.sessionId),this.messageContainer.clear(),this.loadCurrentSessionMessages(),this.updateSessionList(),this.chatInput.focus()}createNewSession(){let e=this.sessionManager.createSession(`Session ${this.sessionManager.getSessions().length}`);this.loadSession(e.id)}deleteSession(e){if(!this.sessionManager.deleteSession(e)){console.error("ClaudeChatView: Failed to delete session:",e);return}let n=this.sessionManager.getCurrentSession();n?this.loadSession(n.id):this.createNewSession()}renameSession(e,t){this.sessionManager.updateSessionName(e,t)&&this.updateSessionList()}async exportConversation(){let e=this.sessionManager.getCurrentMessages();if(e.length===0)return;let t=this.sessionManager.getCurrentSession(),n=(t==null?void 0:t.name)||"Conversation",i=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5),d=`claude-chat-${n.replace(/[^a-zA-Z0-9]/g,"-")}-${i}.md`,l=`# Claude Chat Conversation

`;l+=`**Session:** ${n}

`,l+=`*Exported: ${new Date().toLocaleString()}*

`,l+=`*Claude Session ID: ${(t==null?void 0:t.sessionId)||"N/A"}*

`,l+=`---

`;for(let c of e){if(c.role==="system")continue;let o=c.role==="user"?"\u{1F464} User":"\u{1F916} Assistant",f=c.timestamp.toLocaleTimeString();l+=`## ${o}

`,l+=`*${f}*

`,l+=`${c.content}

`,l+=`---

`}let r=this.app.vault;await r.create(d,l),r.getAbstractFileByPath(d)&&await this.app.workspace.openLinkText(d,"",!0)}async handleEditMessage(e,t){console.log("ClaudeChatView: Edit message at index",e,"with new content:",t),this.messageContainer.removeMessagesAfter(e),await this.handleCommand(t)}async regenerateLast(){let e=this.messageContainer.getMessages(),t=-1;for(let n=e.length-1;n>=0;n--)if(e[n].role==="user"){t=n;break}t>=0&&(this.messageContainer.removeMessagesAfter(t-1),await this.handleCommand(e[t].content))}async onClose(){this.processManager.cleanup()}};var T=class{constructor(){this.sessions=[];this.currentSessionId=null;this.onChangeCallbacks=[];this.loadSessions()}loadSessions(s=[],e=null){this.sessions=s.map(t=>({...t,createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt),messages:t.messages.map(n=>({...n,timestamp:new Date(n.timestamp)}))})),this.currentSessionId=e,this.sessions.length===0?this.createSession("Default Session"):this.currentSessionId||(this.currentSessionId=this.sessions[0].id)}getSessions(){return[...this.sessions]}getCurrentSession(){return this.currentSessionId&&this.sessions.find(s=>s.id===this.currentSessionId)||null}getSession(s){return this.sessions.find(e=>e.id===s)||null}createSession(s){let e={id:this.generateId(),name:s,sessionId:null,createdAt:new Date,updatedAt:new Date,messages:[]};return this.sessions.push(e),this.currentSessionId=e.id,this.notifyChange(),e}updateSessionName(s,e){let t=this.getSession(s);return t?(t.name=e,t.updatedAt=new Date,this.notifyChange(),!0):!1}deleteSession(s){let e=this.sessions.findIndex(t=>t.id===s);return e!==-1?(this.sessions.splice(e,1),this.currentSessionId===s&&(this.currentSessionId=this.sessions.length>0?this.sessions[0].id:null,this.sessions.length===0&&this.createSession("Default Session")),this.notifyChange(),!0):!1}switchSession(s){return this.getSession(s)?(this.currentSessionId=s,this.notifyChange(),!0):!1}addMessage(s){let e=this.getCurrentSession();e&&(e.messages.push(s),e.updatedAt=new Date,this.notifyChange())}updateCliSessionId(s){let e=this.getCurrentSession();e&&(e.sessionId=s,e.updatedAt=new Date,this.notifyChange())}clearCurrentSession(){let s=this.getCurrentSession();s&&(s.messages=[],s.updatedAt=new Date,this.notifyChange())}getCurrentMessages(){let s=this.getCurrentSession();return s?s.messages:[]}getCurrentCliSessionId(){let s=this.getCurrentSession();return s?s.sessionId:null}onChange(s){this.onChangeCallbacks.push(s)}exportForSave(){return{sessions:this.sessions,currentSessionId:this.currentSessionId}}notifyChange(){for(let s of this.onChangeCallbacks)s()}generateId(){return`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}};var b=class extends A.Plugin{constructor(){super(...arguments);this.data={sessionId:null,version:"1.0.0",sessions:[],currentSessionId:null};this.sessionManager=new T}async onload(){await this.loadPluginData(),this.registerView(m,e=>new x(e,this)),this.addRibbonIcon("message-square","Open Claude Chat",()=>{this.activateView()}),this.addCommand({id:"open-claude-chat",name:"Open Claude Chat",callback:()=>this.activateView()}),this.addCommand({id:"claude-chat-clear-history",name:"Clear chat history",hotkeys:[{modifiers:["Mod"],key:"k"}],callback:()=>this.clearChatHistory()}),this.addCommand({id:"claude-chat-focus-input",name:"Focus chat input",hotkeys:[{modifiers:["Mod"],key:"l"}],callback:()=>this.focusInput()}),this.addCommand({id:"claude-chat-stop",name:"Stop generation",hotkeys:[{modifiers:[],key:"Escape"}],callback:()=>this.stopGeneration()}),this.addCommand({id:"claude-chat-new-session",name:"Start new session",hotkeys:[{modifiers:["Mod","Shift"],key:"n"}],callback:()=>this.startNewSession()}),this.addCommand({id:"claude-chat-export",name:"Export conversation to Markdown",hotkeys:[{modifiers:["Mod","Shift"],key:"e"}],callback:()=>this.exportConversation()})}async activateView(){let{workspace:e}=this.app,t=e.getLeavesOfType(m)[0];if(t)e.revealLeaf(t);else{let n=e.getRightLeaf(!1);n&&await n.setViewState({type:m,active:!0})}}onunload(){}async loadPluginData(){let e=await this.loadData();if(e){if(this.data=e,!this.data.sessions||this.data.sessions.length===0){let t={id:"session-migrated",name:"Migrated Session",sessionId:this.data.sessionId,createdAt:new Date,updatedAt:new Date,messages:[]};this.data.sessions=[t],this.data.currentSessionId=t.id}this.sessionManager.loadSessions(this.data.sessions,this.data.currentSessionId),this.sessionManager.onChange(()=>{this.saveSessions()}),console.log("ClaudeChat: Loaded data, sessions:",this.data.sessions.length)}else console.log("ClaudeChat: No saved data found, starting fresh"),this.sessionManager.onChange(()=>{this.saveSessions()})}async saveSessions(){let e=this.sessionManager.exportForSave();this.data.sessions=e.sessions,this.data.currentSessionId=e.currentSessionId,await this.saveData(this.data)}async updateSessionId(e){this.sessionManager.updateCliSessionId(e)}getSessionId(){return this.sessionManager.getCurrentCliSessionId()}clearChatHistory(){let{workspace:e}=this.app,t=e.getLeavesOfType(m)[0];if(t){let n=t.view;n.clearHistory&&n.clearHistory()}}focusInput(){let{workspace:e}=this.app,t=e.getLeavesOfType(m)[0];if(t){let n=t.view;n.focusInput&&n.focusInput()}}stopGeneration(){let{workspace:e}=this.app,t=e.getLeavesOfType(m)[0];if(t){let n=t.view;n.handleStop&&n.handleStop()}}startNewSession(){let e=this.sessionManager.createSession(`Session ${this.sessionManager.getSessions().length+1}`),{workspace:t}=this.app,n=t.getLeavesOfType(m)[0];if(n){let i=n.view;i.loadSession&&i.loadSession(e.id)}}async exportConversation(){let{workspace:e}=this.app,t=e.getLeavesOfType(m)[0];if(t){let n=t.view;n.exportConversation&&await n.exportConversation()}}};
